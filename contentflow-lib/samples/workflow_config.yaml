# Document Processing Workflow Configuration
#
# This configuration defines connectors and workflows for document processing.
# Environment variables are resolved using ${VAR_NAME} or ${VAR_NAME:default} syntax.

# Workflow Definitions
pipelines:
  # Basic document processing workflow
  - name: document_processing_basic
    description: Retrieve content, extract with Document Intelligence, index to search
    
    executors:
      # Step 1: Retrieve document content
      - id: retrieve_content
        type: content_retriever
        settings:
          container_name: ${CONTAINER_NAME:documents}
          include_content_bytes_as_field: false
          use_temp_file_for_content: true
          temp_folder: /tmp/doc_proc

      # Step 2: Extract content with Document Intelligence
      - id: extract_content
        type: document_intelligence_extractor
        settings:
          model_id: prebuilt-layout
          extract_text: true
          extract_tables: true
          extract_key_value_pairs: true
      
      # Step 3: Index to AI Search
      - id: index_documents
        type: ai_search_index_writer
        settings:
          index_mode: chunks
          id_field: id
          content_field: content
          chunk_field: chunks
          metadata_fields:
            - source
            - extracted_at
            - page_number
    
    execution_sequence:
      - retrieve_content
      - extract_content
      - index_documents
  
  # Advanced workflow with AI enrichment
  - name: document_processing_with_enrichment
    description: Full pipeline with content extraction and AI enrichment
    
    executors:
      # Step 1: Retrieve document content
      - id: retrieve_content
        type: content_retriever
        settings:
          container_name: ${CONTAINER_NAME:documents}
          use_temp_file_for_content: true
        connectors:
          - storage
      
      # Step 2: Extract content with Document Intelligence
      - id: extract_content
        type: document_intelligence_extractor
        settings:
          model_id: prebuilt-layout
          extract_text: true
          extract_tables: true
        connectors:
          - doc_intelligence
      
      # Step 3: Enrich chunks with AI
      - id: enrich_chunks
        type: custom_ai_prompt
        settings:
          system_prompt: |
            You are a document analysis assistant. Analyze the provided document chunk
            and extract key information, entities, and insights.
          user_prompt: |
            Document Source: {source}
            Page: {page_number}
            Content:
            {content}
            
            Provide a structured analysis with:
            - Main topics
            - Key entities (people, organizations, locations)
            - Important dates or numbers
            - Summary
          max_completion_tokens: 500
          temperature: 0.3
          content_iterator_field: chunks
        connectors:
          - ai_model
      
      # Step 4: Index enriched content
      - id: index_documents
        type: ai_search_index_writer
        settings:
          index_mode: chunks
          chunk_field: chunks
          metadata_fields:
            - source
            - page_number
            - ai_analysis
        connectors:
          - search
    
    execution_sequence:
      - retrieve_content
      - extract_content
      - enrich_chunks
      - index_documents
